<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rektopuss x KrauklÄ«Å¡i 3x3 Hokeja TurnÄ«rs (08.02)</title>

  <style>
    :root{
      --bg0:#070A0F;
      --bg1:#0B1020;
      --text:#EAF0FF;
      --muted:#AAB4D6;

      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.07);

      --accent:#6EE7FF;
      --accent2:#A78BFA;

      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;

      /* Sticky column widths */
      --col1: 36px;   /* # */
      --col2: 120px;  /* Komanda */
    }

    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      margin: 20px;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 700px at 95% 10%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(255,214,107,.10), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    /* subtle hockey rink lines + faceoff circles */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.10;
      background:
        radial-gradient(circle at 18% 35%, transparent 0 70px, rgba(255,255,255,.35) 71px 72px, transparent 73px),
        radial-gradient(circle at 82% 35%, transparent 0 70px, rgba(255,255,255,.35) 71px 72px, transparent 73px),
        radial-gradient(circle at 50% 68%, transparent 0 85px, rgba(255,255,255,.35) 86px 87px, transparent 88px),
        linear-gradient(90deg, transparent 0 12%, rgba(255,255,255,.22) 12% 12.3%, transparent 12.3% 87.7%, rgba(255,255,255,.22) 87.7% 88%, transparent 88% 100%),
        linear-gradient(0deg, transparent 0 18%, rgba(255,255,255,.16) 18% 18.2%, transparent 18.2% 82%, rgba(255,255,255,.16) 82% 82.2%, transparent 82.2% 100%),
        repeating-linear-gradient(135deg, rgba(255,255,255,.10) 0 2px, transparent 2px 10px);
      mix-blend-mode: overlay;
    }

    .wrap{ max-width: 1200px; margin: 0 auto; position:relative; }

    header{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
      text-align:center;
      margin-bottom: 10px;
    }

    h1{
      margin: 0;
      font-size: clamp(30px, 3.8vw, 46px);
      letter-spacing: .3px;
      line-height: 1.05;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(14,22,43,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .chip .dot{
      width:8px; height:8px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 12px rgba(110,231,255,.6);
    }

    .small { font-size: 12px; color: var(--muted); margin-top: 6px; }
    #status{ margin-top: 14px; text-align:center; }

    .grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      background: linear-gradient(180deg, rgba(14,22,43,.82), rgba(10,16,33,.72));
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(110,231,255,.18), transparent 60%),
        radial-gradient(500px 220px at 90% 20%, rgba(167,139,250,.18), transparent 60%);
      opacity:.6;
      pointer-events:none;
      filter: blur(0.2px);
    }

    .card > *{ position:relative; }

    h2{
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: .3px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .groupBadge{
      font-size:12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.15);
      color: var(--muted);
      white-space: nowrap;
    }

    /* ---- TABLE: scroll + sticky header/columns ---- */
    .tableScroll{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(8,12,24,.35);
    }

    table.standingsTable{
      width: 100%;
      border-collapse: separate;   /* important for sticky backgrounds */
      border-spacing: 0;
      font-size: 14px;
      min-width: 620px;            /* enables horizontal scroll on phones */
    }

    table.standingsTable th,
    table.standingsTable td{
      border-bottom: 1px solid var(--line2);
      padding: 8px 6px;
      text-align: center;
      color: rgba(234,240,255,.92);
      background: transparent;
    }

    table.standingsTable thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.92);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .6px;
      backdrop-filter: blur(6px);
    }

    table.standingsTable td.team,
    table.standingsTable th.team{
      text-align:left;
      padding-left:10px;
    }

    /* Column widths */
    table.standingsTable th:nth-child(1),
    table.standingsTable td:nth-child(1){
      width: var(--col1);
      min-width: var(--col1);
      max-width: var(--col1);
    }
    table.standingsTable th:nth-child(2),
    table.standingsTable td:nth-child(2){
      width: var(--col2);
      min-width: var(--col2);
      max-width: var(--col2);
    }

    /* Sticky first two columns */
    table.standingsTable th:nth-child(1),
    table.standingsTable td:nth-child(1){
      position: sticky;
      left: 0;
      z-index: 6;
      background: rgba(12,18,36,.85);
      backdrop-filter: blur(6px);
    }
    table.standingsTable th:nth-child(2),
    table.standingsTable td:nth-child(2){
      position: sticky;
      left: var(--col1);
      z-index: 6;
      background: rgba(12,18,36,.78);
      backdrop-filter: blur(6px);
    }
    /* Ensure header cells stay above body sticky cells */
    table.standingsTable thead th:nth-child(1),
    table.standingsTable thead th:nth-child(2){
      z-index: 8;
      background: rgba(18,26,50,.92);
    }

    /* Row hover + subtle highlights */
    table.standingsTable tbody tr{
      transition: transform .12s ease, background .12s ease;
    }
    table.standingsTable tbody tr:hover{
      background: rgba(110,231,255,.06);
      transform: translateY(-1px);
    }
    table.standingsTable tbody tr:hover td:nth-child(1),
    table.standingsTable tbody tr:hover td:nth-child(2){
      background: rgba(18,26,50,.92);
    }

    /* Highlight rank 1 row */
    table.standingsTable tbody tr:nth-child(1) td{
      background: linear-gradient(90deg, rgba(110,231,255,.10), rgba(167,139,250,.08));
    }
    table.standingsTable tbody tr:nth-child(1) td:nth-child(1),
    table.standingsTable tbody tr:nth-child(1) td:nth-child(2){
      background: rgba(18,26,50,.92);
    }
    table.standingsTable tbody tr:nth-child(1) td:last-child b{
      color: var(--accent);
      text-shadow: 0 0 18px rgba(110,231,255,.35);
    }

    /* ---- BRACKET ---- */
    .bracket{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      margin-top:18px;
      background: linear-gradient(180deg, rgba(14,22,43,.78), rgba(10,16,33,.68));
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }

    .bracket::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 260px at 10% 0%, rgba(255,214,107,.16), transparent 60%),
        radial-gradient(700px 260px at 95% 10%, rgba(110,231,255,.16), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .bracket > *{ position:relative; }

    /* Fix mobile wrapping for bracket title row */
    .bracket h2{
      display:flex;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
    }

    .brrow { display:flex; flex-wrap:wrap; gap:14px; }

    .match{
      border:1px solid var(--line2);
      border-radius: 14px;
      padding:10px;
      min-width:280px;
      flex: 1;
      background: rgba(8,12,24,.35);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      position: relative;
      overflow:hidden;
    }

    .match::after{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(420px 160px at 20% 0%, rgba(110,231,255,.12), transparent 60%);
      opacity:.7;
      pointer-events:none;
    }
    .match > *{ position:relative; }

    .mtitle{
      font-weight:700;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      letter-spacing:.2px;
    }

    .mtitle .stageTag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      color: var(--muted);
      background: rgba(0,0,0,.15);
      white-space:nowrap;
    }

    .line{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 8px;
      border-radius:10px;
      background: rgba(255,255,255,.03);
    }
    .line + .line{ margin-top:6px; background: rgba(255,255,255,.02); }

    .muted{
      color: var(--muted);
      font-size:12px;
      margin-top:8px;
      line-height:1.35;
    }

    .pill{
      display:inline-block;
      padding:2px 10px;
      border:1px solid var(--line2);
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.18);
      white-space: nowrap; /* prevent ugly line breaks */
      margin-left: 0;      /* better wrapping on mobile */
    }

    .trophy{
      display:inline-block;
      margin-left:6px;
      filter: drop-shadow(0 6px 16px rgba(255,214,107,.18));
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      body{ margin: 14px; }
      h1{ font-size: clamp(26px, 7vw, 38px); }
      table.standingsTable{ font-size: 12px; min-width: 600px; }
      table.standingsTable thead th{ font-size: 11px; }
      table.standingsTable th, table.standingsTable td{ padding: 7px 5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Rektopuss x KrauklÄ«Å¡i 3x3 Hokeja TurnÄ«rs (08.02)</h1>
        <div class="small">Punkti: Uzvara (reg.) = 3, Uzvara papildlaikÄ = 2, ZaudÄ“jums papildlaikÄ = 1, ZaudÄ“jums (reg.) = 0</div>
      </div>

      <div class="meta">
        <div class="chip" title="TieÅ¡saistes rezultÄti">
          <span class="dot"></span>
          <span>TieÅ¡raide â€¢ rezultÄti atjaunojas automÄtiski</span>
        </div>
      </div>
    </header>

    <div id="tables" class="grid"></div>

    <div id="bracket"></div>

    <div class="small" id="status"></div>
  </div>

<script>
  // âœ… PASTE YOUR APPS SCRIPT WEB APP URL HERE
  const API_URL = "https://script.google.com/macros/s/AKfycby0vrGmqMUMI9xk08Vqdg1u2Fgz5F2LUXexpBo4gdxZlo4v56D0nqCSFQK62TVlyI4s/exec";

  // refresh interval (ms)
  const REFRESH_MS = 15000;

  /*************** GROUP STANDINGS LOGIC ***************/
  function computeStandings(groupName, teamsByGroup, games) {
    const teams = teamsByGroup[groupName] || [];
    const stats = {};
    teams.forEach(t => stats[t] = { team:t, GP:0, W:0, OW:0, OL:0, L:0, GF:0, GA:0, GD:0, PTS:0 });

    const groupGames = (games || []).filter(g => g.group === groupName);

    for (const g of groupGames) {
      const home = g.home, away = g.away;
      const hg = Number(g.hg), ag = Number(g.ag);
      const type = String(g.type || "").toUpperCase();

      if (!stats[home] || !stats[away]) continue;
      if (!Number.isFinite(hg) || !Number.isFinite(ag)) continue;
      if (hg === ag) continue;

      stats[home].GP++; stats[away].GP++;
      stats[home].GF += hg; stats[home].GA += ag;
      stats[away].GF += ag; stats[away].GA += hg;

      const homeWin = hg > ag;
      const winner = homeWin ? home : away;
      const loser  = homeWin ? away : home;

      if (type === "REG") {
        stats[winner].W += 1;
        stats[loser].L += 1;
        stats[winner].PTS += 3;
      } else if (type === "OT") {
        stats[winner].OW += 1;
        stats[loser].OL += 1;
        stats[winner].PTS += 2;
        stats[loser].PTS += 1;
      }
    }

    for (const t of teams) stats[t].GD = stats[t].GF - stats[t].GA;

    return Object.values(stats).sort((a,b) =>
      (b.PTS - a.PTS) ||
      (b.GD - a.GD) ||
      (b.GF - a.GF) ||
      a.team.localeCompare(b.team)
    );
  }

  function renderTables(teamsByGroup, games) {
    const container = document.getElementById("tables");
    container.innerHTML = "";

    for (const groupName of Object.keys(teamsByGroup)) {
      const standings = computeStandings(groupName, teamsByGroup, games);
      const gamesCount = (games || []).filter(g => g.group === groupName).length;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h2>
          <span>${groupName}</span>
          <span class="groupBadge">${gamesCount}/6 spÄ“les</span>
        </h2>

        <div class="tableScroll">
          <table class="standingsTable">
            <thead>
              <tr>
                <th style="width:44px;">#</th>
                <th class="team" style="width:170px;">Komanda</th>
                <th>SP</th><th>U</th><th>UP</th><th>ZP</th><th>Z</th>
                <th>GF</th><th>GA</th><th>GD</th><th>Punkti</th>
              </tr>
            </thead>
            <tbody>
              ${standings.map((r,i)=>`
                <tr>
                  <td>${i+1}</td>
                  <td class="team">${r.team}</td>
                  <td>${r.GP}</td><td>${r.W}</td><td>${r.OW}</td><td>${r.OL}</td><td>${r.L}</td>
                  <td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td><td><b>${r.PTS}</b></td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div class="small">AizvadÄ«tÄs spÄ“les grupÄ: ${gamesCount} (maks. 6)</div>
      `;
      container.appendChild(card);
    }
  }

  /*************** PLAYOFF / BRACKET LOGIC ***************/
  function flattenTeamRows(teamsByGroup, games) {
    const all = {};
    for (const groupName of Object.keys(teamsByGroup)) {
      const standings = computeStandings(groupName, teamsByGroup, games);
      standings.forEach(r => all[r.team] = { ...r, group: groupName });
    }
    return all;
  }

  function pickWinnersAndWildcard(teamsByGroup, games) {
    const winners = {};
    const winnerTeams = new Set();

    for (const groupName of Object.keys(teamsByGroup)) {
      const standings = computeStandings(groupName, teamsByGroup, games);
      const first = standings[0];
      winners[groupName] = first ? first.team : null;
      if (first) winnerTeams.add(first.team);
    }

    const allRows = Object.values(flattenTeamRows(teamsByGroup, games));
    const candidates = allRows.filter(r => !winnerTeams.has(r.team));

    candidates.sort((a,b) =>
      (b.PTS - a.PTS) ||
      (b.GD - a.GD) ||
      (b.GF - a.GF) ||
      a.team.localeCompare(b.team)
    );

    const wildcard = candidates[0]?.team || null;
    return { winners, wildcard, wildcardRow: candidates[0] || null };
  }

  function playoffMap(playoffsArr) {
    const m = {};
    (playoffsArr || []).forEach(g => {
      const stage = String(g.stage || "").toUpperCase();
      m[stage] = g;
    });
    return m;
  }

  function winnerOf(game) {
    if (!game) return null;
    const hg = Number(game.hg), ag = Number(game.ag);
    if (!Number.isFinite(hg) || !Number.isFinite(ag) || hg === ag) return null;
    return hg > ag ? game.home : game.away;
  }

  function loserOf(game) {
    if (!game) return null;
    const hg = Number(game.hg), ag = Number(game.ag);
    if (!Number.isFinite(hg) || !Number.isFinite(ag) || hg === ag) return null;
    return hg > ag ? game.away : game.home;
  }

  function renderBracket(teamsByGroup, games, playoffsArr) {
    const bracketEl = document.getElementById("bracket");

    const { winners, wildcard, wildcardRow } = pickWinnersAndWildcard(teamsByGroup, games);

    const A  = winners["Group A"];
    const B  = winners["Group B"];
    const C  = winners["Group C"];
    const WC = wildcard;

    const pm = playoffMap(playoffsArr);

    const sf1Display = pm.SF1 || (A && C ? { home:A, away:C } : null);
    const sf2Display = pm.SF2 || (B && WC ? { home:B, away:WC } : null);

    const sf1W = winnerOf(pm.SF1);
    const sf2W = winnerOf(pm.SF2);
    const sf1L = loserOf(pm.SF1);
    const sf2L = loserOf(pm.SF2);

    const goldDisplay   = pm.GOLD   || (sf1W && sf2W ? { home: sf1W, away: sf2W } : null);
    const bronzeDisplay = pm.BRONZE || (sf1L && sf2L ? { home: sf1L, away: sf2L } : null);

    function matchHtml(title, g) {
      if (!g) {
        return `
          <div class="match">
            <div class="mtitle">${title} <span class="stageTag">gaida</span></div>
            <div class="muted">Gaida grupu rezultÄtusâ€¦</div>
          </div>
        `;
      }
      const hg = Number(g.hg), ag = Number(g.ag);
      const hasScore = Number.isFinite(hg) && Number.isFinite(ag);
      return `
        <div class="match">
          <div class="mtitle">
            <span>${title}</span>
            <span class="stageTag">${hasScore ? "pabeigta" : "nav aizvadÄ«ta"}</span>
          </div>
          <div class="line"><span>${g.home}</span><span>${hasScore ? hg : "â€”"}</span></div>
          <div class="line"><span>${g.away}</span><span>${hasScore ? ag : "â€”"}</span></div>
          <div class="muted">${hasScore ? "SpÄ“le pabeigta" : "VÄ“l nav aizvadÄ«ta"}</div>
        </div>
      `;
    }

    const wcInfo = wildcardRow
      ? `${wildcardRow.PTS} punkti, GD ${wildcardRow.GD}, GF ${wildcardRow.GF} (${wildcardRow.group})`
      : "â€”";

    bracketEl.innerHTML = `
      <div class="bracket">
        <h2 style="margin:0 0 10px;">
          IzslÄ“gÅ¡anas spÄ“les <span class="pill">AutomÄtiska izloze</span>
          <span class="trophy">ğŸ†</span><span class="trophy">ğŸ’</span>
        </h2>

        <div class="muted" style="margin-bottom:10px;">
          Katras grupas uzvarÄ“tÄji + 1 â€œwildcardâ€ (labÄkÄ komanda pÄ“c <b>punktiem</b>, tad <b>vÄrtiem</b>).
          <br/>
          PusfinÄls 1: A grupa vs C grupa â€¢ PusfinÄls 2: B grupa vs Wildcard â€¢ UzvarÄ“tÄji â†’ Zelts â€¢ ZaudÄ“tÄji â†’ Bronza
          <br/>
          Wildcard: <b>${WC || "TBD"}</b> <span class="pill">${wcInfo}</span>
        </div>

        <div class="brrow">
          ${matchHtml("PusfinÄls 1 (A vs C)", sf1Display)}
          ${matchHtml("PusfinÄls 2 (B vs Wildcard)", sf2Display)}
        </div>

        <div class="brrow" style="margin-top:12px;">
          ${matchHtml("SpÄ“le par bronzu", bronzeDisplay)}
          ${matchHtml("FinÄls (zelts)", goldDisplay)}
        </div>
      </div>
    `;
  }

  /*************** NETWORK / REFRESH ***************/
  async function fetchState() {
    const res = await fetch(API_URL, { method:"GET" });
    return res.json();
  }

  async function tick() {
    const status = document.getElementById("status");
    try {
      status.textContent = "Atjauno datusâ€¦";
      const data = await fetchState();
      if (!data.ok) throw new Error(data.error || "NeizdevÄs ielÄdÄ“t");

      renderTables(data.teamsByGroup || {}, data.games || []);
      renderBracket(data.teamsByGroup || {}, data.games || [], data.playoffs || []);

      status.textContent = "PÄ“dÄ“jais atjauninÄjums: " + new Date().toLocaleString();
    } catch (e) {
      status.textContent = "KÄ¼Å«da ielÄdÄ“jot datus: " + e.message;
    }
  }

  tick();
  setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
